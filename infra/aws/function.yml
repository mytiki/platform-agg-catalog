AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Ocean-Catalog Lambda Function

Parameters:
  BucketName:
    Type: String
    Description: Enter the S3 bucket name for the lake.
  DatabaseName:
    Type: String
    Description: Enter the database name for the lake.
  UtilsName:
    Type: String
    Default: core-iceberg-utils
    Description: Enter the name of the utils layer.
  UtilsVersion:
    Type: Number
    Description: Enter the version number of the utils layer.

Resources:
  Function:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../..
      Handler: com.mytiki.ocean.catalog.App::handleRequest
      Runtime: java17
      Architectures:
        - arm64
      MemorySize: 512
      Timeout: 20
      FunctionUrlConfig:
        AuthType: AWS_IAM
        InvokeMode: BUFFERED
        Cors:
          AllowCredentials: true
          MaxAge: 0
          AllowHeaders:
            - Authorization
            - Content-Type
            - Accept
          AllowMethods:
            - GET
            - POST
            - DELETE
          AllowOrigins:
            - "*"
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref BucketName
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - glue:GetTable
                - glue:GetTables
                - glue:GetDatabase
                - glue:GetDatabases
                - glue:CreateTable
                - glue:DeleteTable
                - glue:UpdateTable
              Resource:
                - !Sub "arn:aws:glue:${AWS::Region}:${AWS::AccountId}:catalog"
                - !Sub "arn:aws:glue:${AWS::Region}:${AWS::AccountId}:database/${DatabaseName}"
                - !Sub "arn:aws:glue:${AWS::Region}:${AWS::AccountId}:table/${DatabaseName}/*"
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:${UtilsName}:${UtilsVersion}"
